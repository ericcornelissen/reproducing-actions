# WARNING:
# When using this reusable workflow, provide only trusted values to the inputs
# `build-cmd` and `install-cmd`. These inputs are embedded directly into scripts
# because they are meant to be executed as commands.

name: Check
on:
  workflow_call:
    inputs:
      # Setup
      build-cmd:
        required: true
        type: string
      install-cmd:
        required: true
        type: string

      # Node.js
      node-version:
        required: false
        type: string
        default: ""
      node-version-file:
        required: false
        type: string
        default: ""

      # Target
      repository:
        required: true
        type: string
      working-directory:
        required: false
        type: string
        default: ""

permissions: read-all

jobs:
  setup:
    name: setup
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Determine version to reproduce
        id: version
        env:
          REPO: ${{ inputs.repository }}
        run: |
          WORKFLOW=$(echo "${REPO//\//-}.yml" | tr '[:upper:]' '[:lower:]')
          VERSION=$( \
            cat ".github/workflows/$WORKFLOW" \
              | grep -oE '^\s+- uses: [^@]+@v?[^"]*' \
              | sed 's/.*@//' \
          )
          echo "$VERSION"
          echo "VERSION=$VERSION" >>"$GITHUB_OUTPUT"
  build:
    name: build ${{ needs.setup.outputs.version }}
    runs-on: ubuntu-24.04
    needs:
      - setup
    env:
      BACKUP_DIR: /tmp/reproducing-actions
      CHECKSUMS_FILE: /tmp/reproducing-actions-checksums.txt
    steps:
      # Repository setup
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          ref: ${{ needs.setup.outputs.version }}
          repository: ${{ inputs.repository }}
      - name: Obtain original list of files
        id: files
        run: |
          TMP=$(find . \( -path ./.git \) -prune -o -type f -print)
          echo "$TMP"

          {
            echo 'lines<<EOF'
            echo -n "$TMP"
            echo 'EOF'
          } >>"${GITHUB_OUTPUT}"
          echo "list=$(echo $TMP | tr '\n' ' ')" >>"${GITHUB_OUTPUT}"

      # Environment setup
      - name: Install Node.js (from version)
        if: ${{ inputs.node-version != '' }}
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ inputs.node-version }}
          package-manager-cache: false
      - name: Install Node.js (from version file)
        if: ${{ inputs.node-version-file != '' }}
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: ${{ inputs.node-version-file }}
          package-manager-cache: false
      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: ${{ inputs.install-cmd }}

      # Check reproducibility
      - name: Normalize line endings
        env:
          FILES: ${{ steps.files.outputs.lines }}
        run: |
          while IFS= read -r file; do
            echo "Normalizing line endings in '$file'"
            sed -i 's/\r*$//' "$file"
          done <<<"$FILES"
      - name: Store original files
        env:
          FILES: ${{ steps.files.outputs.list }}
        run: |
          mkdir --parents "$BACKUP_DIR"
          cp --parents $FILES "$BACKUP_DIR"
      - name: Compute original checksums (legacy)
        env:
          FILES: ${{ steps.files.outputs.list }}
        run: |
          shasum --algorithm 512 $FILES >$CHECKSUMS_FILE

          echo 'Checksums:'
          echo '----------'
          cat $CHECKSUMS_FILE

      - name: Rebuild
        working-directory: ${{ inputs.working-directory }}
        run: ${{ inputs.build-cmd }}

      - name: Normalize line endings
        env:
          FILES: ${{ steps.files.outputs.lines }}
        run: |
          while IFS= read -r file; do
            echo "Normalizing line endings in '$file'"
            sed -i 's/\r*$//' "$file"
          done <<<"$LINES"
      - name: Check byte-by-byte equality
        env:
          FILES: ${{ steps.files.outputs.lines }}
        run: |
          while IFS= read -r file; do
            rebuild=$file
            original=$BACKUP_DIR/$file
            echo "Checking '$rebuild' against '$original'"
            cmp "$rebuild" "$original"
          done <<<"$LINES"
      - name: Check checksums (legacy)
        run: shasum --strict --check $CHECKSUMS_FILE
      - name: Check for new files
        env:
          FILES: ${{ steps.files.outputs.lines }}
        run: |
          git clean -dfX

          BEFORE=$LINES
          AFTER=$(find . \( -path ./.git \) -prune -o -type f -print)
          if [ "$BEFORE" != "$AFTER" ]; then
            echo '--- FILES BEFORE ---'
            echo "$BEFORE"
            echo '--- FILES AFTER ---'
            echo "$AFTER"
            exit 1
          fi

      - name: Build files diff
        if: ${{ failure() }}
        env:
          FILES: ${{ steps.files.outputs.lines }}
        run: |
          while IFS= read -r file; do
            echo "--- Diff of '$file' ---"
            git diff "$file"
          done <<<"$LINES"
